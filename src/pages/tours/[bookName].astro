---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Navigation from "../../components/Navigation";
import Concierge from "../../components/Concierge.astro";
import Footer from "../../components/Footer";
import TourHighlights from "../../components/TourHighlights.astro";
import TourPhotoGallery from "../../components/TourPhotoGallery.astro";
import { getTours } from "../../data/tours";
import type { Tour } from "../../types/tour";
import type { ItemList, TouristTrip, WithContext } from "schema-dts";

export async function getStaticPaths() {
  const tours = await getTours();

  return tours.map((tour) => ({
    params: { bookName: tour.bookName },
    props: { tour },
  }));
}

const { tour } = Astro.props as { tour?: Tour };

if (!tour) {
  throw new Response("Tour niet gevonden", { status: 404 });
}

const fallbackImage =
  "https://images.unsplash.com/photo-1555881400-74d7acaacd8b?q=80&w=2070";
const heroImage = tour.images[0]?.original || fallbackImage;
const locationLabel = tour.location === "lisbon" ? "Lissabon" : "Sintra";
const canonicalUrl = Astro.site
  ? new URL(Astro.url.pathname, Astro.site).href
  : undefined;

const parsePrice = (value: string): number | null => {
  const match = value.match(/([0-9]+(?:[.,][0-9]{2})?)/);
  if (!match) {
    return null;
  }

  const normalized = match[1].replace(".", "").replace(",", ".");
  const numeric = Number.parseFloat(normalized);
  return Number.isFinite(numeric) ? numeric : null;
};

const numericPrice = parsePrice(tour.price);
const itinerary: ItemList | undefined = tour.landmarks.length
  ? {
      "@type": "ItemList",
      itemListElement: tour.landmarks.map((landmark, index) => ({
        "@type": "ListItem",
        position: index + 1,
        item: {
          "@type": "Place",
          name: landmark,
        },
      })),
    }
  : undefined;

const tourJsonLd: WithContext<TouristTrip> = {
  "@context": "https://schema.org",
  "@type": "TouristTrip",
  name: tour.name,
  description: tour.description,
  image: heroImage,
  provider: {
    "@type": "TravelAgency",
    name: "Just Lisbon",
    url: "https://www.just-lisbon.com",
  },
  ...(canonicalUrl ? { url: canonicalUrl } : {}),
  ...(itinerary ? { itinerary } : {}),
  ...(numericPrice
    ? {
        offers: {
          "@type": "Offer",
          price: numericPrice,
          priceCurrency: "EUR",
          availability: "https://schema.org/InStock",
        },
      }
    : {}),
};

const meta = {
  title: `${tour.name} — Just Lisbon`,
  description: tour.description,
};
---

<BaseLayout
  title={meta.title}
  description={meta.description}
  image={heroImage}
  imageAlt={`${tour.name} — Nederlandse gids in ${locationLabel}`}
  jsonLd={tourJsonLd}
>
  <Navigation />
  <article class="relative md:pt-10">
    <section class="relative isolate overflow-hidden border-b border-bone/10">
      <div class="absolute inset-0">
        <img
          src={heroImage}
          alt={tour.name}
          class="h-full w-full object-cover object-center"
          loading="eager"
          fetchpriority="high"
          decoding="async"
        />
      </div>
      <div
        class="absolute inset-0 bg-gradient-to-b from-black/85 via-black/65 to-midnight/95"
      >
      </div>
      <div class="relative mx-auto max-w-5xl px-6 py-24 lg:px-8">
        <div
          class="flex flex-col gap-6 rounded-3xl border border-white/10 p-8 shadow-2xl shadow-black/40 backdrop-blur-sm lg:p-12"
        >
          <div class="inline-flex w-fit items-center gap-3">
            <span
              class="rounded-full border border-white/10 bg-white/10 px-4 py-1 text-[0.65rem] uppercase tracking-[0.35em] text-bone/80"
            >
              {locationLabel}
            </span>
          </div>
          <div class="space-y-6">
            <h1 class="font-display text-4xl text-bone md:text-6xl">
              {tour.name}
            </h1>
            <p
              class="max-w-2xl text-sm leading-relaxed text-bone/85 md:text-base"
            >
              {tour.description}
            </p>
            <div
              class="flex flex-col gap-4 sm:flex-row sm:items-center sm:gap-6"
            >
              <a
                href="#contact"
                class="inline-flex items-center justify-center rounded-full border border-accent/40 bg-accent/10 px-6 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-accent transition hover:border-accent hover:bg-accent/20 hover:text-champagne"
              >
                Boek Nu
              </a>
              <span class="text-xs uppercase tracking-[0.35em] text-bone/65">
                Vanaf {tour.price.replace("\n", " / ")}
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mx-auto max-w-6xl px-6 py-16 lg:px-8 lg:py-24">
      <div class="grid gap-16 lg:grid-cols-[2fr,1fr]">
        <div class="space-y-16">
          <TourHighlights landmarks={tour.landmarks} />

          <TourPhotoGallery
            images={tour.images}
            fallbackImage={fallbackImage}
            tourName={tour.name}
          />
        </div>

        <aside class="space-y-6">
          <div
            class="sticky top-32 space-y-6 rounded-3xl border border-bone/10 bg-slate/30 p-8 shadow-lg shadow-black/10 backdrop-blur"
          >
            <h2 class="font-display text-2xl text-bone">
              Inbegrepen in deze tour
            </h2>
            <ul class="space-y-4 text-sm text-bone/70">
              {
                tour.included.map((item) => (
                  <li class="flex items-start gap-3">
                    <span class="mt-1 inline-flex h-2.5 w-2.5 rounded-full bg-accent/80" />
                    <span>{item}</span>
                  </li>
                ))
              }
            </ul>
            <div class="border-t border-bone/10 pt-6 text-sm text-bone/70">
              <p class="text-xs uppercase tracking-[0.3em] text-bone/40">
                Prijsindicatie
              </p>
              <p
                class="mt-3 whitespace-pre-line text-lg font-semibold text-bone"
              >
                {tour.price}
              </p>
            </div>
            <a
              href="#contact"
              class="inline-flex w-full items-center justify-center rounded-full border border-accent/40 px-6 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-accent transition hover:border-accent hover:text-champagne"
            >
              Boek Nu
            </a>
            <p class="text-[0.7rem] uppercase tracking-[0.3em] text-bone/40">
              Persoonlijke aanpassingen zijn altijd mogelijk. Laat ons weten wat
              u wenst.
            </p>
          </div>
        </aside>
      </div>
    </section>
  </article>
  <Concierge selectedTour={tour.name} />
  <Footer />
</BaseLayout>
