---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Navigation from "../../components/Navigation";
import Concierge from "../../components/Concierge.astro";
import Footer from "../../components/Footer";
import TourHighlights from "../../components/TourHighlights.astro";
import TourPhotoGallery from "../../components/TourPhotoGallery.astro";
import { getTours } from "../../data/tours";
import { buildTourEventJsonLd } from "../../lib/structuredData/tourEvents";
import { buildTourProductJsonLd } from "../../lib/structuredData/tourProduct";
import { buildTouristTripJsonLd } from "../../lib/structuredData/touristTrip";
import type { Tour } from "../../types/tour";

export async function getStaticPaths() {
  const tours = await getTours();

  return tours.map((tour) => ({
    params: { bookName: tour.slug },
    props: { tour },
  }));
}

const { tour } = Astro.props as { tour?: Tour };

if (!tour) {
  throw new Response("Tour niet gevonden", { status: 404 });
}

const fallbackImage =
  "https://images.unsplash.com/photo-1555881400-74d7acaacd8b?q=80&w=2070";
const heroImage = tour.images[0] || fallbackImage;
const locationLabel = tour.location === "lisbon" ? "Lissabon" : "Sintra";
// TODO: Add "Gerelateerde tours" once direct Storyblok support is available.
const canonicalUrl = Astro.site
  ? new URL(Astro.url.pathname, Astro.site).href
  : undefined;
const tourJsonLd = buildTouristTripJsonLd(tour, {
  siteUrl: Astro.site,
  heroImage,
  url: canonicalUrl,
});

const meta = {
  title: `${tour.name} met Nederlandse gids in ${locationLabel} | Just Lisbon`,
  description: tour.description,
};
const tourEventJsonLd = buildTourEventJsonLd(tour, { siteUrl: Astro.site });
const tourProductJsonLd = buildTourProductJsonLd(tour, { siteUrl: Astro.site });
---

<BaseLayout
  title={meta.title}
  description={meta.description}
  image={heroImage}
  imageAlt={`${tour.name} â€” Nederlandse gids in ${locationLabel}`}
  jsonLd={[tourJsonLd, tourEventJsonLd, tourProductJsonLd]}
>
  <Navigation client:load />
  <article class="relative md:pt-10">
    <section class="relative isolate overflow-hidden border-b border-bone/10">
      <div class="absolute inset-0">
        <img
          src={heroImage}
          alt={tour.name}
          class="h-full w-full object-cover object-center"
          loading="eager"
          fetchpriority="high"
          decoding="async"
        />
      </div>
      <div
        class="absolute inset-0 bg-gradient-to-b from-midnight/82 via-midnight/45 to-midnight/88"
      >
      </div>
      <div
        class="absolute inset-0 bg-[radial-gradient(circle_at_20%_20%,rgba(242,193,107,0.26),transparent_44%)]"
      >
      </div>
      <div class="absolute inset-y-0 left-0 w-full bg-gradient-to-r from-midnight/90 via-midnight/72 to-midnight/38 lg:w-3/4">
      </div>
      <div class="absolute inset-x-0 bottom-0 h-36 bg-gradient-to-t from-midnight/92 to-transparent">
      </div>
      <div class="relative mx-auto flex min-h-[74vh] max-w-6xl items-end px-6 pb-14 pt-28 lg:px-8 lg:pb-20">
        <div
          class="w-full max-w-4xl rounded-[2rem] border border-white/20 bg-black/32 p-7 shadow-2xl shadow-black/40 backdrop-blur-md lg:p-10"
        >
          <div class="space-y-7">
            <nav
              aria-label="Breadcrumb"
              class="flex max-w-full flex-wrap items-center gap-x-3 gap-y-1 text-[0.6rem] uppercase tracking-[0.22em] text-bone/72 sm:tracking-[0.28em]"
            >
              <a href="/" class="transition hover:text-accent">Home</a>
              <span aria-hidden="true">/</span>
              <a href="/#tours" class="transition hover:text-accent">Tours</a>
              <span aria-hidden="true" class="hidden md:inline">/</span>
              <span aria-current="page" class="basis-full text-bone leading-snug md:basis-auto">
                {tour.name}
              </span>
            </nav>
            <div class="space-y-5">
              <span
                class="inline-flex w-fit items-center rounded-full border border-white/30 bg-black/35 px-4 py-1 text-[0.65rem] uppercase tracking-[0.35em] text-bone backdrop-blur-sm"
              >
                {locationLabel}
              </span>
              <h1
                class="max-w-3xl font-display text-4xl leading-tight text-bone drop-shadow-[0_4px_16px_rgba(0,0,0,0.55)] md:text-6xl md:leading-[1.08]"
              >
                {tour.name}
              </h1>
              <p
                class="max-w-2xl text-base leading-relaxed text-bone/95 drop-shadow-[0_2px_10px_rgba(0,0,0,0.45)] md:text-xl"
              >
                {tour.description}
              </p>
            </div>
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:gap-5">
              <a
                href="#contact"
                class="inline-flex items-center justify-center rounded-full border border-transparent bg-accent px-7 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-midnight transition hover:bg-champagne"
                data-ph-event="tour_page_book_click"
                data-ph-tour={tour.name}
                data-ph-location={locationLabel}
                data-ph-placement="hero"
              >
                Boek Nu
              </a>
              <p
                class="inline-flex w-fit items-center rounded-full border border-white/25 bg-black/35 px-4 py-2 text-xs uppercase tracking-[0.35em] text-bone/90"
              >
                Vanaf {tour.price.replace("\n", " / ")}
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mx-auto max-w-6xl px-6 py-16 lg:px-8 lg:py-24">
      <div class="grid gap-16 lg:grid-cols-[2fr,1fr]">
        <div class="space-y-16">
          <TourHighlights landmarks={tour.landmarks} />

          <TourPhotoGallery
            images={tour.images}
            fallbackImage={fallbackImage}
            tourName={tour.name}
          />
        </div>

        <aside class="space-y-6">
          <div
            class="sticky top-32 space-y-6 rounded-3xl border border-bone/10 bg-slate/30 p-8 shadow-lg shadow-black/10 backdrop-blur"
          >
            <h2 class="font-display text-2xl text-bone">
              Inbegrepen in deze tour
            </h2>
            <ul class="space-y-4 text-sm text-bone/70">
              {
                tour.included.map((item) => (
                  <li class="flex items-start gap-3">
                    <span class="mt-1 inline-flex h-2.5 w-2.5 rounded-full bg-accent/80" />
                    <span>{item}</span>
                  </li>
                ))
              }
            </ul>
            <div class="border-t border-bone/10 pt-6 text-sm text-bone/70">
              <p class="text-xs uppercase tracking-[0.3em] text-bone/40">
                Prijs
              </p>
              <p
                class="mt-3 whitespace-pre-line text-lg font-semibold text-bone"
              >
                {tour.price}
              </p>
            </div>
            <a
              href="#contact"
              class="inline-flex w-full items-center justify-center rounded-full border border-accent/40 px-6 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-accent transition hover:border-accent hover:text-champagne"
              data-ph-event="tour_page_book_click"
              data-ph-tour={tour.name}
              data-ph-location={locationLabel}
              data-ph-placement="sidebar"
            >
              Boek Nu
            </a>
            <a
              href="/#tours"
              class="inline-flex w-full items-center justify-center rounded-full border border-bone/30 px-6 py-3 text-xs font-semibold uppercase tracking-[0.35em] text-bone/70 transition hover:border-accent hover:text-accent"
            >
              Alle Tours
            </a>
            <p class="text-[0.7rem] uppercase tracking-[0.3em] text-bone/40">
              persoonlijke aanpassingen zijn altijd mogelijk, laat ons weten wat
              je wenst.
            </p>
          </div>
        </aside>
      </div>
    </section>
  </article>
  <Concierge selectedTour={tour.name} />
  <Footer />
</BaseLayout>
